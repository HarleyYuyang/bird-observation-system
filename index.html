<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鸟类观测记录系统</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
        }
        #container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 20px;
            font-size: 24px;
            font-weight: 500;
            color: #2c3e50;
            text-align: center;
        }
        .header-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        .header-info .form-group {
            margin-bottom: 10px;
        }
        .header-info .form-group:last-child {
            margin-bottom: 0;
        }
        .header-info label {
            display: inline-block;
            width: 80px;
            margin-right: 10px;
        }
        .header-info input {
            width: calc(100% - 90px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #search {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        #search:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.2);
        }
        #suggestions {
            border: 1px solid #eee;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
        }
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        #status {
            color: #666;
            margin-top: 12px;
            font-size: 14px;
            font-style: italic;
        }
        .recording-controls {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .recording-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .recording-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            transition: all 0.3s ease;
        }
        .recording-indicator.active {
            background-color: #ff4444;
            animation: pulse 1.5s infinite;
        }
        .recording-text {
            font-size: 16px;
            color: #666;
        }
        .recording-text.active {
            color: #ff4444;
        }
        .recording-stats {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .recording-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .recording-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .start-button {
            background-color: #4CAF50;
            color: white;
        }
        .start-button:hover {
            background-color: #45a049;
        }
        .stop-button {
            background-color: #f44336;
            color: white;
        }
        .stop-button:hover {
            background-color: #da190b;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #f5f5f5;
        }
        .close-button:hover {
            color: #333;
            background-color: #eee;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 15px;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.2);
        }
        .action-links {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            font-size: 16px;
            justify-content: center;
        }
        .action-link {
            color: #4CAF50;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px 20px;
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        .action-link:hover {
            color: #45a049;
            background-color: #f0f0f0;
        }
        .bird-name {
            font-size: 22px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>鸟类观测记录系统</h1>
        <div class="header-info">
            <div class="form-group">
                <label for="location">地点：</label>
                <input type="text" id="location" placeholder="请输入观测地点">
            </div>
            <div class="form-group">
                <label for="weather">天气：</label>
                <input type="text" id="weather" placeholder="请输入天气情况">
            </div>
            <div class="form-group">
                <label for="environment">环境类型：</label>
                <input type="text" id="environment" placeholder="请输入环境类型">
            </div>
        </div>
        <input type="text" id="search" placeholder="输入鸟类名称..." oninput="filterSuggestions()">
        <div id="suggestions"></div>
        <div class="recording-controls">
            <div class="recording-status">
                <span class="recording-indicator" id="recordingIndicator"></span>
                <span class="recording-text" id="recordingText">未开始记录</span>
            </div>
            <div class="recording-stats" id="recordingStats">
                当前记录：0 种鸟类
            </div>
            <div class="recording-buttons">
                <button class="recording-button start-button" id="startRecording">开始记录</button>
                <button class="recording-button stop-button" id="stopRecording" style="display: none;">结束记录</button>
            </div>
        </div>
        <div id="status">准备就绪</div>
    </div>

    <!-- 观测记录弹窗 -->
    <div id="observationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div class="bird-name" id="birdName"></div>
            <form id="observationForm">
                <div class="form-group">
                    <label for="quantity">数量：</label>
                    <input type="number" id="quantity" name="quantity" required min="1" placeholder="请输入数量">
                </div>
                <div class="form-group">
                    <label for="notes">备注：</label>
                    <textarea id="notes" name="notes" rows="4" placeholder="请输入备注信息"></textarea>
                </div>
                <div class="action-links">
                    <span class="action-link" onclick="document.getElementById('observationForm').dispatchEvent(new Event('submit'))">保存记录</span>
                </div>
            </form>
            <div id="modalStatus"></div>
        </div>
    </div>

    <script>
        // 直接嵌入JSON数据
        const birdSpecies = [
  {
    "鸟类分类索引": "Struthioniformes",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Ostriches",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Struthionidae",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "非洲鸵鸟",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Common Ostrich",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Struthio camelus",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "索马里鸵鸟",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Somali Ostrich",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Struthio molybdophanes",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Rheiformes",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Rheas",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Rheidae",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "大美洲鸵",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Greater Rhea",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Rhea americana",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "小美洲鸵",
    "English Name": null,
    "Latin Name": null
  },
  {
    "鸟类分类索引": "Lesser Rhea",
    "English Name": null,
    "Latin Name": null
  },

          // 为了节省空间，这里只包含了部分数据
          // 您可以将完整的JSON数据放在这里
        ];

        const statusElement = document.getElementById('status');
        statusElement.textContent = `数据已加载，共 ${birdSpecies.length} 条记录`;

        // 初始化状态
        let isRecording = false;
        let recordedBirds = new Set();
        const recordingIndicator = document.getElementById('recordingIndicator');
        const recordingText = document.getElementById('recordingText');
        const recordingStats = document.getElementById('recordingStats');
        const startButton = document.getElementById('startRecording');
        const stopButton = document.getElementById('stopRecording');

        // 页面加载时初始化
        window.addEventListener('load', function() {
            // 恢复表头信息
            const savedHeaderInfo = localStorage.getItem('header_info');
            if (savedHeaderInfo) {
                const headerInfo = JSON.parse(savedHeaderInfo);
                document.getElementById('location').value = headerInfo.location || '';
                document.getElementById('weather').value = headerInfo.weather || '';
                document.getElementById('environment').value = headerInfo.environment || '';
            }

            // 恢复记录状态
            const recordingStartTime = localStorage.getItem('recording_start_time');
            if (recordingStartTime) {
                startRecording();
            }

            // 更新状态显示
            updateRecordingStats();
        });

        // 保存表头信息
        function saveHeaderInfo() {
            const headerInfo = {
                location: document.getElementById('location').value,
                weather: document.getElementById('weather').value,
                environment: document.getElementById('environment').value
            };
            localStorage.setItem('header_info', JSON.stringify(headerInfo));
        }

        // 添加表头信息自动保存
        document.getElementById('location').addEventListener('change', saveHeaderInfo);
        document.getElementById('weather').addEventListener('change', saveHeaderInfo);
        document.getElementById('environment').addEventListener('change', saveHeaderInfo);

        // 更新记录统计
        function updateRecordingStats() {
            const observations = JSON.parse(localStorage.getItem('bird_observations') || '[]');
            const startTime = localStorage.getItem('recording_start_time');
            if (startTime) {
                const recordedObservations = observations.filter(obs => 
                    new Date(obs.timestamp) >= new Date(startTime)
                );
                // 使用 Set 来确保每个鸟类只计算一次
                const uniqueBirds = new Set(recordedObservations.map(obs => obs.birdId));
                recordingStats.textContent = `当前记录：${uniqueBirds.size} 种鸟类`;
                
                // 更新记录文本，显示当前记录的鸟类
                if (uniqueBirds.size > 0) {
                    const birdNames = recordedObservations
                        .filter(obs => uniqueBirds.has(obs.birdId))
                        .map(obs => obs.birdName)
                        .join('、');
                    recordingText.textContent = `正在记录中... (${birdNames})`;
                } else {
                    recordingText.textContent = '正在记录中...';
                }
            } else {
                recordingStats.textContent = '当前记录：0 种鸟类';
                recordingText.textContent = '未开始记录';
            }
        }

        // 开始记录
        function startRecording() {
            isRecording = true;
            recordedBirds.clear();
            recordingIndicator.classList.add('active');
            recordingText.classList.add('active');
            recordingText.textContent = '正在记录中...';
            startButton.style.display = 'none';
            stopButton.style.display = 'block';
            localStorage.setItem('recording_start_time', new Date().toISOString());
            updateRecordingStats();
        }

        // 结束记录
        function stopRecording() {
            isRecording = false;
            recordingIndicator.classList.remove('active');
            recordingText.classList.remove('active');
            recordingText.textContent = '未开始记录';
            startButton.style.display = 'block';
            stopButton.style.display = 'none';
            exportRecordings();
            clearRecordingData();
        }

        // 添加记录
        function addRecordedBird(birdId) {
            if (isRecording) {
                recordedBirds.add(birdId);
                updateRecordingStats();
            }
        }

        // 清空记录数据
        function clearRecordingData() {
            try {
                const keys = Object.keys(localStorage);
                const birdKeys = keys.filter(key => key.startsWith('bird_observation_'));
                birdKeys.forEach(key => localStorage.removeItem(key));
                localStorage.removeItem('bird_observations');
                localStorage.removeItem('recording_start_time');
                recordedBirds.clear();
                updateRecordingStats();
                statusElement.textContent = `已清空 ${birdKeys.length} 条观测记录`;
                setTimeout(() => {
                    statusElement.textContent = `数据已加载，共 ${birdSpecies.length} 条记录`;
                }, 3000);
            } catch (error) {
                console.error('清空数据时发生错误：', error);
                statusElement.textContent = '清空数据时发生错误';
            }
        }

        // 导出记录
        function exportRecordings() {
            const startTime = localStorage.getItem('recording_start_time');
            const observations = JSON.parse(localStorage.getItem('bird_observations') || '[]');
            
            // 获取表头信息
            const location = document.getElementById('location').value || '未填写';
            const weather = document.getElementById('weather').value || '未填写';
            const environment = document.getElementById('environment').value || '未填写';
            
            // 过滤出记录期间的观测数据
            const recordedObservations = observations.filter(obs => 
                new Date(obs.timestamp) >= new Date(startTime)
            );

            if (recordedObservations.length === 0) {
                statusElement.textContent = '没有找到记录期间的观测数据';
                return;
            }

            // 准备CSV数据
            const BOM = '\uFEFF';
            const headerInfo = [
                ['观测地点', location],
                ['天气情况', weather],
                ['环境类型', environment],
                ['记录时间', new Date().toLocaleString()],
                ['']
            ].map(row => row.join(',')).join('\n');

            const dataHeaders = ['序号', '鸟类编号', '鸟类名称', '数量', '备注', '记录时间'];
            
            const csvContent = [
                headerInfo,
                dataHeaders.join(','),
                ...recordedObservations.map((obs, index) => {
                    const fields = [
                        index + 1,
                        `"${obs.birdId}"`,
                        `"${obs.birdName}"`,
                        obs.quantity,
                        `"${obs.notes.replace(/"/g, '""')}"`,
                        `"${new Date(obs.timestamp).toLocaleString()}"`
                    ];
                    return fields.join(',');
                })
            ].join('\n');

            // 创建下载链接
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            const fileName = `鸟类观测记录_${new Date().toLocaleDateString()}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            statusElement.textContent = `已导出 ${recordedObservations.length} 条记录`;
            setTimeout(() => {
                statusElement.textContent = `数据已加载，共 ${birdSpecies.length} 条记录`;
            }, 3000);
        }

        // 显示观测弹窗
        function showObservationModal(birdId, birdName) {
            const modal = document.getElementById('observationModal');
            const birdNameElement = document.getElementById('birdName');
            const modalStatus = document.getElementById('modalStatus');
            
            birdNameElement.textContent = birdName;
            modal.style.display = 'block';
            
            // 加载已有数据
            const existingData = localStorage.getItem(`bird_observation_${birdId}`);
            if (existingData) {
                const data = JSON.parse(existingData);
                document.getElementById('quantity').value = data.quantity || '';
                document.getElementById('notes').value = data.notes || '';
                modalStatus.textContent = '已加载之前的记录';
            } else {
                document.getElementById('quantity').value = '';
                document.getElementById('notes').value = '';
                modalStatus.textContent = '';
            }

            // 设置表单提交事件
            const form = document.getElementById('observationForm');
            form.onsubmit = function(e) {
                e.preventDefault();
                const data = {
                    birdName: birdName,
                    quantity: document.getElementById('quantity').value,
                    notes: document.getElementById('notes').value,
                    timestamp: new Date().toISOString()
                };

                // 保存到本地存储
                localStorage.setItem(`bird_observation_${birdId}`, JSON.stringify(data));

                // 保存到记录列表
                let observations = JSON.parse(localStorage.getItem('bird_observations') || '[]');
                const existingIndex = observations.findIndex(obs => obs.birdId === birdId);
                
                if (existingIndex !== -1) {
                    observations[existingIndex] = { ...data, birdId };
                } else {
                    observations.push({ ...data, birdId });
                }
                
                localStorage.setItem('bird_observations', JSON.stringify(observations));

                // 添加到记录中
                addRecordedBird(birdId);

                modalStatus.textContent = '记录已保存！';
                setTimeout(() => {
                    modalStatus.textContent = '';
                    closeModal();
                    // 更新记录状态显示
                    updateRecordingStats();
                }, 1500);
            };
        }

        // 关闭弹窗
        function closeModal() {
            const modal = document.getElementById('observationModal');
            modal.style.display = 'none';
            // 清空检索输入框
            document.getElementById('search').value = '';
            // 隐藏建议列表
            document.getElementById('suggestions').style.display = 'none';
            statusElement.textContent = '记录已保存';
            setTimeout(() => {
                statusElement.textContent = `数据已加载，共 ${birdSpecies.length} 条记录`;
            }, 3000);
        }

        // 点击弹窗外部关闭弹窗
        window.onclick = function(event) {
            const modal = document.getElementById('observationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 添加按钮事件监听
        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);

        // 过滤建议
        function filterSuggestions() {
            const input = document.getElementById('search').value.trim();
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';

            if (input) {
                const filteredSpecies = birdSpecies.filter(species => 
                    species["鸟类分类索引"] && species["鸟类分类索引"].toLowerCase().includes(input.toLowerCase())
                );

                if (filteredSpecies.length > 0) {
                    suggestions.style.display = 'block';
                    filteredSpecies.forEach(species => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = species["鸟类分类索引"];
                        div.onclick = () => {
                            document.getElementById('search').value = species["鸟类分类索引"];
                            suggestions.style.display = 'none';
                            const birdId = species["鸟类分类索引"].replace(/\s+/g, '_').toLowerCase();
                            showObservationModal(birdId, species["鸟类分类索引"]);
                        };
                        suggestions.appendChild(div);
                    });
                    statusElement.textContent = `找到 ${filteredSpecies.length} 条匹配记录`;
                } else {
                    suggestions.style.display = 'none';
                    statusElement.textContent = '没有找到匹配记录';
                }
            } else {
                suggestions.style.display = 'none';
                statusElement.textContent = `数据已加载，共 ${birdSpecies.length} 条记录`;
            }
        }

        // 点击页面其他地方时隐藏建议列表
        document.addEventListener('click', function(event) {
            if (event.target.id !== 'search' && !event.target.classList.contains('suggestion-item')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // 添加回车键处理
        document.getElementById('search').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const input = this.value.trim();
                if (input) {
                    const matchingSpecies = birdSpecies.find(species => 
                        species["鸟类分类索引"] && species["鸟类分类索引"].toLowerCase() === input.toLowerCase()
                    );
                    if (matchingSpecies) {
                        const birdId = matchingSpecies["鸟类分类索引"].replace(/\s+/g, '_').toLowerCase();
                        showObservationModal(birdId, matchingSpecies["鸟类分类索引"]);
                    }
                }
            }
        });
    </script>
</body>
</html>